---
import { actions, isInputError } from "astro:actions";
import { Send } from "lucide-react";
const { postSlug } = Astro.props;

const result = Astro.getActionResult(actions.addComment);
const generalError =
  result?.error && !isInputError(result.error) ? result.error.message : null;
---

<form method="POST" action={actions.addComment} class="mb-10" id="comment-form">
  <input type="hidden" name="postSlug" value={postSlug} />
  <input type="hidden" name="timestamp" value={Date.now().toString()} />

  <!-- Honeypot -->
  <div class="sr-only" aria-hidden="true">
    <label for="website">Website</label>
    <input
      type="text"
      id="website"
      name="website"
      tabindex="-1"
      autocomplete="off"
    />
  </div>

  <div id="message-container" class="mb-4">
    {
      generalError && (
        <div class="text-sm text-red-600 mb-3">{generalError}</div>
      )
    }

    {
      result?.data && (
        <div class="text-sm text-green-600 mb-3">
          Comment submitted successfully!
        </div>
      )
    }
  </div>

  <!-- Comment Box -->
  <div class="relative">
    <textarea
      id="message"
      name="message"
      required
      rows="3"
      placeholder=" "
      class="peer w-full px-3 pt-5 pb-2 bg-transparent border border-gray-200 shadow-sm rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300 resize-none text-base leading-relaxed"
    ></textarea>

    <label
      for="message"
      class="absolute left-3 top-2 text-gray-500 text-sm transition-all
           peer-placeholder-shown:top-3
           peer-placeholder-shown:text-base
           peer-placeholder-shown:text-gray-400
           peer-focus:top-2
           peer-focus:text-sm
           peer-focus:text-gray-600">
      Write a comment
    </label>
  </div>

  <div class="flex flex-col sm:flex-row gap-3 mt-1 text-sm">
    <div class="relative flex-1">
      <input
        type="text"
        id="name"
        name="name"
        required
        placeholder=" "
        class="peer w-full px-3 pt-5 pb-2 border border-gray-200 shadow-sm rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300"
      />

      <label
        for="name"
        class="absolute left-3 top-2 text-gray-500 text-sm transition-all
           peer-placeholder-shown:top-3
           peer-placeholder-shown:text-base
           peer-placeholder-shown:text-gray-400
           peer-focus:top-2
           peer-focus:text-sm
           peer-focus:text-gray-600">
        Your name
      </label>
    </div>

    <div class="relative flex-1">
      <input
        type="email"
        id="email"
        name="email"
        required
        placeholder=" "
        class="peer w-full px-3 pt-5 pb-2 border border-gray-200 shadow-sm rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300"
      />

      <label
        for="email"
        class="absolute left-3 top-2 text-gray-500 text-sm transition-all
           peer-placeholder-shown:top-3
           peer-placeholder-shown:text-base
           peer-placeholder-shown:text-gray-400
           peer-focus:top-2
           peer-focus:text-sm
           peer-focus:text-gray-600">
        Email (not shown publicly)
      </label>
    </div>
    <!-- Submit Button -->
    <button
      type="submit"
      id="submit-btn"
      aria-label="Submit button"
      class="group
       sm:w-[50px]
      h-[50px]
      rounded-xl
      bg-white
      border border-blue-600 shadow-sm
      flex items-center justify-center
      transition
      hover:bg-blue-600
      disabled:opacity-50">
      <Send size={22} className="text-blue-600 transition group-hover:text-white" />
    </button>

    <p class="text-red-500 text-sm mt-1 hidden" id="message-error"></p>
  </div>
</form>

<script>
  import { actions, isInputError } from "astro:actions";

  const form = document.getElementById("comment-form") as HTMLFormElement;
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
  const messageContainer = document.getElementById(
    "message-container"
  ) as HTMLDivElement;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Disable button and show loading state
    submitBtn.disabled = true;

    // Get form data
    const formData = new FormData(form);

    window.addEventListener("load", () => {
      // Update timestamp
      formData.set("timestamp", Date.now().toString());
    });

    try {
      // Call the action directly
      const { error } = await actions.addComment(formData);

      if (error) {
        // Handle input errors
        if (isInputError(error)) {
          Object.entries(error.fields).forEach(([field, message]) => {
            const errorEl = document.getElementById(`${field}-error`);
            if (errorEl && Array.isArray(message)) {
              errorEl.textContent = message[0];
              errorEl.classList.remove("hidden");
            }
          });
        } else {
          // General error
          messageContainer.innerHTML = `
            <div class="mb-4 p-3 text-sm bg-red-100 text-red-700 rounded">
              ${error.message || "An error occurred"}
            </div>
          `;
        }
      } else {
        // Success
        messageContainer.innerHTML = `
          <div class="mb-4 p-3 text-sm bg-green-100 text-green-700 rounded">
            Comment submitted successfully!
          </div>
        `;

        // Reset form
        form.reset();

        // Dispatch event to refresh comments list
        window.dispatchEvent(new CustomEvent("commentAdded"));

        // Hide success message after 3 seconds
        setTimeout(() => {
          messageContainer.innerHTML = "";
        }, 3000);
      }
    } catch (error) {
      messageContainer.innerHTML = `
        <div class="mb-4 p-3 bg-red-100 text-red-700 rounded">
          Failed to submit comment. Please try again.
        </div>
      `;
    } finally {
      // Re-enable button
      submitBtn.disabled = false;
    }
  });
</script>
